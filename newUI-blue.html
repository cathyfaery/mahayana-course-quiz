<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å¤§ä¹˜å£‡ç¶“ï½œå­¸å“¡ç·šä¸Šé¡Œç›®è¤‡ç¿’é›²ç«¯ç‰ˆ</title>
<style>
/* ===== Theme ===== */
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --ink:#0f172a;
  --muted:#64748b;
  --brand:#2563eb;   /* Topbar blue */
  --ok:#16a34a;
  --bad:#ef4444;
  --line:#e5e7eb;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans TC",sans-serif;
  background:var(--bg);
  color:var(--ink);
  padding-top:72px; /* leave space for fixed topbar */
}

/* ===== Top banner (blue bar) ===== */
.topbar{
  position:fixed;
  inset:0 0 auto 0;
  height:64px;
  background:var(--brand);
  color:#fff;
  display:flex;
  align-items:center;
  z-index:1000;
  box-shadow:0 2px 10px rgba(0,0,0,.08);
}
.topbar .inner{
  max-width:1000px;
  width:100%;
  margin:0 auto;
  padding:0 16px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}
.logo{
  width:32px;height:32px;border-radius:50%;
  display:grid;place-items:center;
  background:rgba(255,255,255,.15);
}
.logo svg{width:20px;height:20px;fill:#fff}
.topbar .title{
  font-size:22px;         /* å¤§å‹æ˜“è®€ */
  font-weight:700;
  letter-spacing:.5px;
  white-space:nowrap;
  text-align:center;
}

/* ===== Layout ===== */
.wrap{max-width:1000px;margin:24px auto;padding:0 16px}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  box-shadow:0 10px 30px rgba(15,23,42,.06);
  padding:18px;
}
h1{margin:0 0 8px;font-size:28px}
.sub{color:var(--muted);font-size:13px}

/* ===== Controls: unify font size ===== */
.controls, .controls *{font-size:16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

/* Inputs / buttons */
button,select{
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px 12px;
  background:#fff;
  color:var(--ink);
  cursor:pointer;
}
.btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.ghost{background:#fff}
.btn.warn{background:#fff5f5;border-color:#f3dada;color:#b91c1c}

/* Counters / chips */
.badge{
  background:#f1f5f9;
  border:1px solid var(--line);
  border-radius:12px;
  padding:8px 12px;
  margin-right:8px;
  display:inline-flex;
  align-items:center;
}
.hr{height:1px;background:var(--line);margin:14px 0}

/* Question & options */
.question{font-size:22px;line-height:1.7;margin:8px 0 10px}
.opt{
  display:flex;align-items:flex-start;gap:10px;
  border:1px solid var(--line);
  border-radius:12px;
  padding:8px 10px;margin:4px 0;
  font-size:18px;background:#fff
}
.opt.correct{border-color:var(--ok)}
.opt.wrong{border-color:var(--bad)}

/* Feedback */
.feedback{
  margin-top:10px;border:1px solid var(--line);
  border-radius:10px;padding:10px;font-size:17px;background:#f8fafc
}
.feedback.ok{color:var(--ok)}
.feedback.bad{color:var(--bad)}

/* ===== Accessible round pager ===== */
.nav{
  margin-top:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.circle-btn{
  width:56px;height:56px;border-radius:50%;
  border:none;background:var(--brand);color:#fff;
  display:inline-flex;align-items:center;justify-content:center;
  box-shadow:0 6px 16px rgba(37,99,235,.25);
  cursor:pointer; outline:none;
}
.circle-btn svg{width:28px;height:28px;fill:#fff}
.circle-btn:disabled{opacity:.4;cursor:not-allowed}
.circle-btn:focus-visible{box-shadow:0 0 0 4px rgba(37,99,235,.25), 0 6px 16px rgba(37,99,235,.25)}
.nav-hint{color:var(--muted);font-size:14px}

/* Report */
.hidden{display:none}
.report{margin-top:14px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:14px}
.report h3{margin:0 0 10px;font-size:20px}
.report .meta{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.report .meta .chip{background:#f1f5f9;border:1px solid var(--line);border-radius:999px;padding:8px 12px}
.report details{margin:8px 0}
.report summary{cursor:pointer}

/* Responsive */
@media(max-width:980px){
  .topbar .title{font-size:18px}
  h1{font-size:24px}
  .question{font-size:22px}
  .opt{font-size:18px}
  .circle-btn{width:48px;height:48px}
  .circle-btn svg{width:24px;height:24px}
}
</style>
</head>
<body>
  <!-- Top banner with lotus icon -->
  <div class="topbar">
    <div class="inner">
      <div class="logo" aria-hidden="true">
        <!-- lotus icon (white, fits blue background) -->
        <svg viewBox="0 0 24 24" role="img" focusable="false">
          <path d="M12 3c-1.9 2.6-2.7 4.9-2.7 6.9 0 1 .2 1.9.6 2.7-2.2-.3-4.2-1.9-5.6-4.7-1 3.9.4 6.7 3.2 8.4-1.6.2-3 .1-4.3-.3 1.6 3.1 4.1 4.6 7.7 4.6h2.3c3.6 0 6.1-1.5 7.7-4.6-1.3.4-2.7.5-4.3.3 2.8-1.7 4.2-4.5 3.2-8.4-1.4 2.8-3.4 4.4-5.6 4.7.4-.8.6-1.7.6-2.7 0-2-0.8-4.3-2.7-6.9z"/>
        </svg>
      </div>
      <div class="title">å¤§ä¹˜å£‡ç¶“ï½œå­¸å“¡ç·šä¸Šé¡Œç›®è¤‡ç¿’é›²ç«¯ç‰ˆ</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><h1>ç·šä¸Šåˆ·é¡Œå°ç¨‹åº <span class="sub">â€” é›²ç«¯å”¯è®€ç‰ˆ</span></h1></div>
      </div>
    </div>

    <div class="card controls" id="panel-student"></div>
  </div>

<script>
// === é›²ç«¯å”¯è®€ç«¯é»ï¼ˆæ”¹æˆä½ çš„ã€éƒ¨ç½² Aã€‘/execï¼‰ ===
const DEPLOYMENT_URL = 'https://script.google.com/macros/s/AKfycbxCVsc1zc55xpZAr9JEd9Qi1Fy2abK70cGPuMA-USMOr66TnQOuZTYlRSY1msVUM_8rZg/exec';

// å·¥å…·
const $=s=>document.querySelector(s), isArray=Array.isArray;
function normalize(a){ if(a==null) return []; return isArray(a)? [...a].sort((x,y)=>x-y) : [a]; }
function same(a,b){ a=normalize(a); b=normalize(b); return a.length===b.length && a.every((v,i)=>v===b[i]); }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }

// è¼‰å…¥é¡Œåº«ï¼ˆåªè¼‰ä¸€æ¬¡ï¼‰
let BANK=[];
async function loadCloudOnce(){
  try{
    const r=await fetch(DEPLOYMENT_URL,{cache:'no-store'});
    const j=await r.json();
    BANK = Array.isArray(j.bank)? j.bank : [];
  }catch{ BANK=[]; }
  refreshStudent('#panel-student');
}
loadCloudOnce();

// å­¸å“¡ UI
function mountStudent(selector){
  const el=$(selector);
  el.innerHTML=`
    <div class="row">
      <div class="badge">å…± <b class="s-total">0</b> é¡Œ</div>
      <div class="badge">ç›®å‰ï¼š<b class="s-progress">0/0</b></div>
      <div class="badge">å·²ç­”å°ï¼š<b class="s-right">0</b></div>
    </div>
    <div class="row">
      <div>å–®å…ƒä¸»é¡Œï¼š</div>
      <div class="chips s-sections"></div>
    </div>
    <div class="row">
      <div>å‡ºé¡Œæ¨¡å¼</div>
      <select class="s-mode"><option value="order">ä¾é †åº</option><option value="shuffle">éš¨æ©Ÿ</option></select>
      <div>ç·´ç¿’é¡Œæ•¸</div>
      <select class="s-count"><option value="all">å…¨éƒ¨</option><option>5</option><option selected>10</option><option>20</option><option>50</option></select>
      <button class="btn brand s-start">é–‹å§‹ä½œç­”</button>
      <button class="btn ghost s-reset">é‡æ–°ä¾†é</button>
      <button class="btn warn s-finish" disabled>å®Œæˆä¸¦çœ‹æˆç¸¾</button>
    </div>
    <div class="hr"></div>
    <div class="question s-q"></div>
    <div class="s-optBox"></div>
    <div class="feedback s-fb" style="display:none">
      <div class="s-fbTitle"></div>
      <div class="s-fbAns"></div>
      <div class="s-fbExp"></div>
    </div>

    <!-- åœ“å½¢ä¸Šä¸€é¡Œï¼ä¸‹ä¸€é¡Œ -->
    <div class="nav">
      <button class="circle-btn s-prev" aria-label="ä¸Šä¸€é¡Œ" title="ä¸Šä¸€é¡Œ">
        <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </button>
      <div class="nav-hint">é»æ“Šåœ“éˆ•åˆ‡æ›é¡Œç›®</div>
      <button class="circle-btn s-next" aria-label="ä¸‹ä¸€é¡Œ" title="ä¸‹ä¸€é¡Œ">
        <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true"><path d="m10 6 1.41 1.41L8.83 10H18v2H8.83l2.58 2.59L10 16l-6-6z"/></svg>
      </button>
    </div>

    <div class="report hidden s-report"></div>
  `;
  const state={paper:[], idx:0, right:0, user:{}, revealed:{}, firstScored:{}};
  el._state=state;

  renderSections(el);
  el.querySelector('.s-total').textContent=BANK.length;
  adjustCount(el);

  el.querySelector('.s-start').onclick=()=>start(el);
  el.querySelector('.s-reset').onclick=()=>reset(el);
  el.querySelector('.s-prev').onclick=()=>{ if(state.idx>0){state.idx--; render(el);} };
  // æœ€å¾Œä¸€é¡ŒæŒ‰ã€Œä¸‹ä¸€é¡Œã€â†’ æç¤ºå®Œæˆ + é¡¯ç¤ºæˆç¸¾
  el.querySelector('.s-next').onclick=()=>{
    if(state.idx < state.paper.length-1){ state.idx++; render(el); }
    else{ alert('æœ¬æ¬¡ç·´ç¿’å·²å®Œæˆ ğŸ‰'); showReport(el); }
  };
  el.querySelector('.s-finish').onclick=()=>showReport(el);
}
function refreshStudent(selector){ mountStudent(selector); }

function renderSections(root){
  const secs=[...new Set(BANK.map(q=>q.section||'æœªåˆ†é¡'))];
  root.querySelector('.s-sections').innerHTML = secs.map(s=>`
    <label class="chip"><input type="checkbox" value="${s}" checked> ${s}</label>`).join('');
}
function adjustCount(root){
  const n=BANK.length;
  root.querySelectorAll('.s-count option').forEach(o=>{ if(o.value==='all')return; o.disabled=parseInt(o.value,10)>n; });
}

function start(root){
  const st=root._state;
  const mode=root.querySelector('.s-mode').value;
  const wantStr=root.querySelector('.s-count').value;
  const chosen=[...root.querySelectorAll('.s-sections input:checked')].map(i=>i.value);
  if(!chosen.length) return alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ç« ç¯€');
  const poolIdx=BANK.map((q,i)=>({q,i})).filter(x=>chosen.includes(x.q.section||'æœªåˆ†é¡')).map(x=>x.i);
  if(!poolIdx.length) return alert('æ‰€é¸ç« ç¯€ç›®å‰æ²’æœ‰é¡Œç›®');

  let list=(mode==='shuffle')? shuffle(poolIdx) : poolIdx;
  const want=wantStr==='all'? list.length : Math.min(parseInt(wantStr,10), list.length);
  st.paper=list.slice(0,want); st.idx=0; st.right=0; st.user={}; st.revealed={}; st.firstScored={};

  root.querySelector('.s-fb').style.display='none';
  root.querySelector('.s-report').classList.add('hidden');
  root.querySelector('.s-finish').disabled=false;
  render(root);
}
function reset(root){
  const st=root._state;
  st.paper=[]; st.idx=0; st.right=0; st.user={}; st.revealed={}; st.firstScored={};
  root.querySelector('.s-progress')?.textContent='0/0';
  root.querySelector('.s-right')?.textContent='0';
  root.querySelector('.s-q').textContent=''; root.querySelector('.s-optBox').innerHTML='';
  root.querySelector('.s-fb').style.display='none'; root.querySelector('.s-report').classList.add('hidden');
  root.querySelector('.s-finish').disabled=true;
}

function render(root){
  const st=root._state;
  const pi=st.paper[st.idx]; const q=BANK[pi]; if(!q) return;

  // åœ¨æ§åˆ¶åˆ—é¡¯ç¤ºé€²åº¦ï¼ˆå¦‚æœä½¿ç”¨è€…å…ˆ resetï¼Œé€™å…©å€‹å…ƒç´ æœƒä¸å­˜åœ¨ï¼Œå› æ­¤å‰é¢ reset æœ‰ ?.ï¼‰
  const progressEl = root.querySelector('.s-progress');
  if(progressEl) progressEl.textContent = `${st.idx+1}/${st.paper.length}`;
  const rightEl = root.querySelector('.s-right');
  if(rightEl) rightEl.textContent = st.right;

  root.querySelector('.s-q').textContent=q.question||'';

  const box=root.querySelector('.s-optBox'); box.innerHTML='';
  const correct=normalize(q.answer); const isMulti=correct.length>1;
  const cur=normalize(st.user[pi]); const group='opt_'+pi;

  (q.options||[]).forEach((opt,i)=>{
    const row=document.createElement('label'); row.className='opt';
    const ip=document.createElement('input'); ip.type=isMulti?'checkbox':'radio'; ip.name=group; ip.value=i;
    // å›é¡Œä»é¡¯ç¤ºä¹‹å‰é¸æ“‡
    if(isMulti && cur.includes(i)) ip.checked=true;
    if(!isMulti && cur[0]===i) ip.checked=true;

    row.addEventListener('click',(e)=>{
      if(e.target.tagName.toLowerCase()!=='input'){ ip.checked=!ip.checked; }
      if(isMulti){
        const now=new Set(normalize(st.user[pi]));
        if(ip.checked) now.add(i); else now.delete(i);
        st.user[pi]=[...now].sort((a,b)=>a-b);
        if(st.user[pi].length===correct.length){
          const right=same(st.user[pi], q.answer);
          if(!st.firstScored[pi]){ if(right) st.right++; st.firstScored[pi]=true; }
          st.revealed[pi]=true; showFB(root,q,right); colorize(root,q,pi);
        }else{ st.revealed[pi]=false; hideFB(root); colorize(root,q,pi,false); }
      }else{
        st.user[pi]=i; const right=(i===correct[0]);
        if(!st.firstScored[pi]){ if(right) st.right++; st.firstScored[pi]=true; }
        st.revealed[pi]=true; showFB(root,q,right); colorize(root,q,pi);
      }
    });

    const text=document.createElement('div'); text.innerHTML=`<b>${String.fromCharCode(65+i)}.</b> ${opt}`;
    row.appendChild(ip); row.appendChild(text); box.appendChild(row);
  });

  if(st.revealed[pi]){ showFB(root,q,same(st.user[pi], q.answer)); colorize(root,q,pi); }
  else{ hideFB(root); colorize(root,q,pi,false); }
}
function colorize(root,q,pi,show=true){
  const correct=normalize(q.answer);
  const box=root.querySelector('.s-optBox');
  box.querySelectorAll('.opt').forEach((row,i)=>{
    row.classList.remove('correct','wrong');
    if(show){
      if(correct.includes(i)) row.classList.add('correct');
      else{
        const cur=normalize(root._state.user[pi]);
        if(cur.includes(i)) row.classList.add('wrong');
      }
    }
  });
}
function showFB(root,q,ok){
  const fb=root.querySelector('.s-fb'); fb.style.display='block';
  fb.classList.toggle('ok', ok); fb.classList.toggle('bad', !ok);
  root.querySelector('.s-fbTitle').textContent= ok ? 'ç­”å°äº† âœ…' : 'ç­”éŒ¯äº† âŒ';
  const label=normalize(q.answer).map(i=>String.fromCharCode(65+i)).join(', ');
  root.querySelector('.s-fbAns').textContent=`æ­£ç¢ºç­”æ¡ˆï¼š${label}`;
  root.querySelector('.s-fbExp').textContent= q.explanation? `è§£æï¼š${q.explanation}` : 'ï¼ˆæ­¤é¡Œæš«ç„¡è§£æï¼‰';
}
function hideFB(root){ root.querySelector('.s-fb').style.display='none'; }

function showReport(root){
  const st=root._state; if(!st.paper.length) return alert('å°šæœªé–‹å§‹ä½œç­”');
  const total=st.paper.length, answered=Object.keys(st.user).length, right=st.right, acc= total? Math.round(right/total*100):0;
  const wrong=[];
  st.paper.forEach(pi=>{
    const q=BANK[pi]; const cur=normalize(st.user[pi]); const ok=same(cur,q.answer);
    if(!ok){
      wrong.push({
        question:q.question,
        your: cur.map(i=>String.fromCharCode(65+i)).join(', ')||'ï¼ˆæœªä½œç­”æˆ–æœªé¸æ»¿ï¼‰',
        ans: normalize(q.answer).map(i=>String.fromCharCode(65+i)).join(', '),
        exp: q.explanation||''
      });
    }
  });
  const box=root.querySelector('.s-report'); box.classList.remove('hidden');
  box.innerHTML=`
    <div class="report">
      <h3>æˆç¸¾å ±å‘Š</h3>
      <div class="meta">
        <span class="chip">é¡Œæ•¸ï¼š<b>${total}</b></span>
        <span class="chip">ä½œç­”ï¼š<b>${answered}</b></span>
        <span class="chip">ç­”å°ï¼š<b>${right}</b></span>
        <span class="chip">æ­£ç¢ºç‡ï¼š<b>${acc}%</b></span>
      </div>
      ${wrong.length===0? '<p>å¤ªå¼·äº†ï¼æœ¬æ¬¡ç„¡éŒ¯é¡Œ ğŸ‰</p>':
      `<details open><summary>éŒ¯é¡Œæ¸…å–®ï¼ˆ${wrong.length} é¡Œï¼‰</summary>
        <ol>${wrong.map(w=>`<li style="margin:6px 0"><div><b>${w.question}</b></div><div class="sub">ä½ çš„ä½œç­”ï¼š${w.your}ï¼›æ­£è§£ï¼š${w.ans}</div><div class="sub">${w.exp? 'è§£æï¼š'+w.exp:''}</div></li>`).join('')}</ol>
      </details>`}
    </div>`;
}
</script>
</body>
</html>
